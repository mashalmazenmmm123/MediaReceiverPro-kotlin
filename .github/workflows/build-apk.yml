- name: Set up JDK 11
  uses: actions/setup-java@v4
  with:
    distribution: 'temurin'
    java-version: '11'

- name: Restore Gradle cache
  uses: actions/cache@v4
  with:
    path: |
      ~/.gradle/caches
      ~/.gradle/wrapper
    key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}

- name: Decode keystore
  if: secrets.KEYSTORE_BASE64 != ''
  run: |
    echo "$KEYSTORE_BASE64" | base64 --decode > ./app/my-release-key.jks
  env:
    KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

- name: Build Release APK
  run: ./gradlew :app:assembleRelease --no-daemon
  env:
    KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
    KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
    KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

- name: Upload APK artifact
  uses: actions/upload-artifact@v4
  with:
    name: app-release-apk
    path: app/build/outputs/apk/release/*.apk

# اختياري: إنشاء GitHub Release ورفع الـ APK كـ asset
- name: Create Release
  uses: softprops/action-gh-release@v2
  with:
    tag_name: release-${{ github.run_number }}
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Upload release asset
  uses: softprops/action-gh-release@v2
  with:
    files: app/build/outputs/apk/release/app-release.apk
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}